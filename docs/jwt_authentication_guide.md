# JWT í† í° ê¸°ë°˜ Pro ì¸ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

PDF Redactor M ì•±ì˜ Pro ê¸°ëŠ¥ ì¸ì¦ ë°©ì‹ì„ **ë¡œì»¬ í”Œë˜ê·¸ ì €ì¥**ì—ì„œ **JWT í† í° ê¸°ë°˜**ìœ¼ë¡œ ë³€ê²½í•œ ê³¼ì •ì„ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

---

## 1. ì™œ JWT í† í° ë°©ì‹ì´ ë” ë‚˜ì€ê°€?

### ê¸°ì¡´ ë°©ì‹ vs JWT ë°©ì‹ ë¹„êµ

| í•­ëª© | ê¸°ì¡´ (ë¡œì»¬ í”Œë˜ê·¸ ì €ì¥) | JWT í† í° ë°©ì‹ |
|------|------------------------|---------------|
| **ì €ì¥ ë°ì´í„°** | `is_pro_enabled = true` | `eyJhbGciOiJIUzI1...` (JWT) |
| **ê²€ì¦ ì£¼ì²´** | í´ë¼ì´ì–¸íŠ¸ (ì•±) | ì„œë²„ |
| **ìœ„ì¡° ê°€ëŠ¥ì„±** | ğŸ”´ ë†’ìŒ (ë£¨íŒ… ê¸°ê¸°ì—ì„œ ìˆ˜ì • ê°€ëŠ¥) | ğŸŸ¢ ë§¤ìš° ë‚®ìŒ (ì„œëª… ê²€ì¦) |
| **ë§Œë£Œ ê´€ë¦¬** | âŒ ì—†ìŒ | âœ… `exp` í´ë ˆì„ìœ¼ë¡œ ìë™ ë§Œë£Œ |
| **ê¸°ê¸° ë°”ì¸ë”©** | âŒ ì—†ìŒ | âœ… `device_id` í´ë ˆì„ì— í¬í•¨ ê°€ëŠ¥ |
| **ì·¨ì†Œ ê°€ëŠ¥** | âŒ ë¶ˆê°€ëŠ¥ | âœ… ì„œë²„ì—ì„œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì²˜ë¦¬ ê°€ëŠ¥ |

---

## 2. ìš”êµ¬ì‚¬í•­

- Pro ê¸°ëŠ¥ì€ **êµ¬ë…ì´ ì•„ë‹Œ ì˜êµ¬ ë¼ì´ì„ ìŠ¤**
- í•œ ë²ˆ ë“±ë¡í•˜ë©´ **ë‹¤ë¥¸ ê¸°ê¸°ì— ë“±ë¡í•˜ê¸° ì „ê¹Œì§€** ì˜êµ¬ ì‚¬ìš©
- ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ë“±ë¡í•˜ë©´ **ì´ì „ ê¸°ê¸°ì—ì„œëŠ” ì‚¬ìš© ë¶ˆê°€**

---

## 3. JWT í˜ì´ë¡œë“œ êµ¬ì¡°

### ì•±ì—ì„œ ì„œë²„ë¡œ ì „ì†¡í•˜ëŠ” ì •ë³´
```json
{
  "redeem_code": "PROMO-2024-ABCD",
  "device_id": "550e8400-e29b-41d4-a716-446655440000"  // app_uuid
}
```

### ì„œë²„ì—ì„œ ë°œê¸‰í•˜ëŠ” JWT í˜ì´ë¡œë“œ
```json
{
  "sub": "REDEEM-CODE-123",      // ë¦¬ë”¤ì½”ë“œ
  "device_id": "abc123-...",     // ë“±ë¡ëœ ê¸°ê¸° ì‹ë³„ì
  "plan": "pro",                 // Pro ìƒíƒœ
  "iat": 1702450000              // ë°œê¸‰ ì‹œê°„ (exp ì—†ìŒ â†’ ì˜êµ¬ í† í°)
}
```

---

## 4. ê¸°ê¸° ì´ì „ íë¦„

```
[ê¸°ê¸° B]                        [ì„œë²„]                    [ê¸°ê¸° A]
    â”‚                              â”‚                          â”‚
    â”‚ 1. ë¦¬ë”¤ì½”ë“œ + device_id_B    â”‚                          â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
    â”‚                              â”‚                          â”‚
    â”‚                              â”‚ 2. DBì—ì„œ device_id ì—…ë°ì´íŠ¸
    â”‚                              â”‚    (device_id_A â†’ device_id_B)
    â”‚                              â”‚                          â”‚
    â”‚ 3. ìƒˆ JWT ë°œê¸‰               â”‚                          â”‚
    â”‚   (device_id_B í¬í•¨)         â”‚                          â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
    â”‚                              â”‚                          â”‚
    â”‚                              â”‚          [ê¸°ê¸° Aì—ì„œ ë§ˆìŠ¤í‚¹ API í˜¸ì¶œ ì‹œ]
    â”‚                              â”‚                          â”‚
    â”‚                              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                              â”‚  4. JWTì˜ device_id ë¶ˆì¼ì¹˜
    â”‚                              â”‚     â†’ 401 Unauthorized   â”‚
    â”‚                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

---

## 5. êµ¬í˜„ ì•„í‚¤í…ì²˜

### 5.1 ì¸í„°ì…‰í„° ë°©ì‹ ì„ íƒ ì´ìœ 

JWT í† í°ì„ ê°œë³„ API í˜¸ì¶œë§ˆë‹¤ ì „ë‹¬í•˜ëŠ” ëŒ€ì‹ , **OkHttp Interceptor**ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µí†µ ì²˜ë¦¬í•©ë‹ˆë‹¤.

**ì¥ì **:
1. ëª¨ë“  Pro APIì— **ìë™ ì ìš©** (í–¥í›„ ì¶”ê°€ë˜ëŠ” APIë„ í¬í•¨)
2. Repository/UseCaseì—ì„œ **JWT ì²˜ë¦¬ ë¶ˆí•„ìš”** (ì½”ë“œ ì¤‘ë³µ ì œê±°)
3. ì¸ì¦ ë¡œì§ì´ **Network ë ˆì´ì–´ì— ìº¡ìŠí™”** (ê´€ì‹¬ì‚¬ ë¶„ë¦¬)

### 5.2 íŒŒì¼ êµ¬ì¡°

```
core/
â”œâ”€â”€ network/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ JwtTokenProvider.kt      â† ì¸í„°í˜ì´ìŠ¤ (Network â†’ Data ì˜ì¡´ì„± ë¶„ë¦¬)
â”‚   â”œâ”€â”€ interceptor/
â”‚   â”‚   â”œâ”€â”€ ApiKeyInterceptor.kt
â”‚   â”‚   â””â”€â”€ JwtAuthInterceptor.kt    â† JWT í—¤ë” ìë™ ì¶”ê°€
â”‚   â””â”€â”€ di/
â”‚       â””â”€â”€ NetworkModule.kt         â† ì¸í„°ì…‰í„° ì¡°ë¦½
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ JwtTokenProviderImpl.kt  â† JwtTokenProvider êµ¬í˜„ì²´
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â””â”€â”€ SettingsRepositoryImpl.kt â† JWT ì €ì¥/ì¡°íšŒ
â”‚   â””â”€â”€ di/
â”‚       â””â”€â”€ DataModule.kt            â† JwtTokenProvider ë°”ì¸ë”©
â”‚
â””â”€â”€ domain/
    â””â”€â”€ repository/
        â””â”€â”€ SettingsRepository.kt    â† JWT í† í° ì¸í„°í˜ì´ìŠ¤ ì •ì˜
```

### 5.3 ì¸í„°ì…‰í„° ë™ì‘ íë¦„

```
[ë§ˆìŠ¤í‚¹ API í˜¸ì¶œ]
       â†“
[JwtAuthInterceptor]
  â”œâ”€ JWT í† í° ìˆìŒ â†’ Authorization: Bearer <token> í—¤ë” ì¶”ê°€
  â””â”€ JWT í† í° ì—†ìŒ â†’ í—¤ë” ì—†ì´ ì§„í–‰ (ì„œë²„ì—ì„œ 401 ì‘ë‹µ)
       â†“
[ApiKeyInterceptor]
  â””â”€ X-Redact-Api-Key í—¤ë” ì¶”ê°€
       â†“
[ì„œë²„ ìš”ì²­]
```

---

## 6. runBlocking ì‚¬ìš©ì— ëŒ€í•œ ê³ ë ¤ì‚¬í•­

### 6.1 intercept() ì‹¤í–‰ ì‹œì 

```
[API í˜¸ì¶œ]
     â†“
[ViewModel] â†’ coroutineì—ì„œ suspend function í˜¸ì¶œ
     â†“
[Repository.redactPdf()] â†’ suspend function
     â†“
[Retrofit API í˜¸ì¶œ] â†’ OkHttpë¡œ ìš”ì²­ ì „ë‹¬
     â†“
[OkHttp Dispatcher Thread Pool] â† ì—¬ê¸°ì„œ intercept() ì‹¤í–‰!
```

**í•µì‹¬**: `intercept()`ëŠ” **OkHttpì˜ Dispatcher ìŠ¤ë ˆë“œ í’€**ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤. ë©”ì¸ ìŠ¤ë ˆë“œê°€ ì•„ë‹™ë‹ˆë‹¤!

### 6.2 OkHttp Dispatcher ìŠ¤ë ˆë“œ í’€

| ì†ì„± | ê¸°ë³¸ê°’ |
|------|--------|
| ìµœëŒ€ ìŠ¤ë ˆë“œ ìˆ˜ | 64ê°œ |
| í˜¸ìŠ¤íŠ¸ë‹¹ ìµœëŒ€ ì—°ê²° | 5ê°œ |

### 6.3 runBlocking ì•ˆì „ì„±

| ìŠ¤ë ˆë“œ | runBlocking ì‚¬ìš© | ê²°ê³¼ |
|--------|------------------|------|
| **ë©”ì¸ ìŠ¤ë ˆë“œ** | âŒ ìœ„í—˜ | ANR ë°œìƒ |
| **Dispatcher ìŠ¤ë ˆë“œ** | âœ… ì•ˆì „ | í•´ë‹¹ ìŠ¤ë ˆë“œë§Œ ë¸”ë¡œí‚¹ |

í˜„ì¬ êµ¬í˜„ì—ì„œ `runBlocking`ì€ **Dispatcher ìŠ¤ë ˆë“œ í’€ì—ì„œ ì‹¤í–‰**ë˜ë©°, í† í° ì½ê¸°ëŠ” **ë°€ë¦¬ì´ˆ ì´í•˜** ì‘ì—…ì´ë¯€ë¡œ ì‹¤ì§ˆì ìœ¼ë¡œ ì•ˆì „í•©ë‹ˆë‹¤.

### 6.4 ëŒ€ì•ˆ: ë©”ëª¨ë¦¬ ìºì‹œ ë°©ì‹

`runBlocking`ì„ ì™„ì „íˆ ì œê±°í•˜ë ¤ë©´ **ë©”ëª¨ë¦¬ ìºì‹œ**ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```kotlin
// 1. ë©”ëª¨ë¦¬ ìºì‹œ í™€ë”
@Singleton
class JwtTokenHolder @Inject constructor() {
    @Volatile
    var token: String? = null
        private set
    
    fun setToken(jwt: String?) { token = jwt }
}

// 2. í† í° ì €ì¥ ì‹œ í™€ë”ì—ë„ ë°˜ì˜
override suspend fun saveJwtToken(token: String) {
    dataStore.edit { it[JWT_TOKEN] = token }
    tokenHolder.setToken(token)  // ë©”ëª¨ë¦¬ì—ë„ ì €ì¥
}

// 3. ì¸í„°ì…‰í„°ì—ì„œ ë™ê¸°ì  ì ‘ê·¼
override fun intercept(chain: Interceptor.Chain): Response {
    val token = tokenHolder.token  // runBlocking ë¶ˆí•„ìš”!
    // ...
}
```

í˜„ì¬ DataStoreë„ ë‚´ë¶€ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ ìºì‹±ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ì‹¤ì§ˆì ì¸ ì„±ëŠ¥ ì°¨ì´ëŠ” ë¯¸ë¯¸í•©ë‹ˆë‹¤.

---

## 7. ì„œë²„ API ìˆ˜ì • ì‚¬í•­

### 7.1 ë¦¬ë”¤ì½”ë“œ ê²€ì¦ API ì‘ë‹µ ë³€ê²½

**ê¸°ì¡´ ì‘ë‹µ**:
```json
{
  "is_valid": true,
  "message": "ì½”ë“œ ê²€ì¦ ì„±ê³µ"
}
```

**ë³€ê²½ í›„ ì‘ë‹µ**:
```json
{
  "is_valid": true,
  "message": "ì½”ë“œ ê²€ì¦ ì„±ê³µ",
  "jwt_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### 7.2 ë§ˆìŠ¤í‚¹ API í—¤ë” ê²€ì¦ ì¶”ê°€

ë§ˆìŠ¤í‚¹ APIì—ì„œ `Authorization: Bearer <token>` í—¤ë”ë¥¼ ê²€ì¦í•˜ê³ , í† í°ì˜ `device_id`ì™€ ìš”ì²­ì˜ ê¸°ê¸°ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

**401 Unauthorized ì‘ë‹µ** (ê¸°ê¸° ë¶ˆì¼ì¹˜ ì‹œ):
```json
{
  "message": "ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ Pro ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
}
```

---

## 8. ë³€ê²½ëœ íŒŒì¼ ëª©ë¡

| ë ˆì´ì–´ | íŒŒì¼ | ë³€ê²½ ë‚´ìš© |
|--------|------|----------|
| **Network** | `JwtAuthInterceptor.kt` | ì‹ ê·œ - JWT í—¤ë” ìë™ ì¶”ê°€ ì¸í„°ì…‰í„° |
| **Network** | `JwtTokenProvider.kt` | ì‹ ê·œ - JWT í† í° ì œê³µì ì¸í„°í˜ì´ìŠ¤ |
| **Network** | `NetworkModule.kt` | JwtAuthInterceptorë¥¼ RedactOkHttpClientì— ì ìš© |
| **Network** | `RedactionApi.kt` | Authorization í—¤ë” íŒŒë¼ë¯¸í„° ì œê±° |
| **Network** | `ValidateCodeResponseDto.kt` | `jwt_token` í•„ë“œ ì¶”ê°€ |
| **Data** | `JwtTokenProviderImpl.kt` | ì‹ ê·œ - JwtTokenProvider êµ¬í˜„ì²´ |
| **Data** | `DataModule.kt` | JwtTokenProvider ë°”ì¸ë”© ì¶”ê°€ |
| **Data** | `SettingsRepositoryImpl.kt` | JWT ì €ì¥/ì¡°íšŒ/ì‚­ì œ ë©”ì„œë“œ ì¶”ê°€ |
| **Data** | `RedeemRepositoryImpl.kt` | JWT í† í° ë°˜í™˜ ë¡œì§ êµ¬í˜„ |
| **Data** | `RemoteRedactionRepositoryImpl.kt` | jwtToken íŒŒë¼ë¯¸í„° ì œê±° |
| **Domain** | `SettingsRepository.kt` | JWT í† í° ê´€ë ¨ ë©”ì„œë“œ ì¶”ê°€ |
| **Domain** | `RedeemRepository.kt` | ë°˜í™˜ íƒ€ì… Boolean â†’ String(JWT) |
| **Domain** | `RemoteRedactionRepository.kt` | jwtToken íŒŒë¼ë¯¸í„° ì œê±° |
| **Domain** | `ValidateCodeUseCase.kt` | device_id ìë™ í¬í•¨, JWT ì €ì¥ |
| **Domain** | `RemoteRedactPdfUseCase.kt` | JWT ì¡°íšŒ ë¡œì§ ì œê±° (ì¸í„°ì…‰í„°ê°€ ì²˜ë¦¬) |
| **Feature** | `HomeViewModel.kt` | uuid íŒŒë¼ë¯¸í„° ì œê±° |
